<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.76.5" />


<title>Docker上のElasticsearchをcurlで操作する - きまいボックス</title>
<meta property="og:title" content="Docker上のElasticsearchをcurlで操作する - きまいボックス">


  <link href='https://kenji-imi.github.io/favicon.ico' rel='icon' type='image/x-icon'/>



  




<link rel="icon" href="https://kenji-imi.github.io/images/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" href="https://kenji-imi.github.io/css/main.css" media="all">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather:400|Lato:400,400italic,700">

  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="https://kenji-imi.github.io/" class="nav-logo">
    <img src="https://kenji-imi.github.io/images/ki.png" 
         width="50" 
         height="50" 
         alt="Logo">
  </a>

  <ul class="nav-links">
    
    <li><a href="/profile/">Profile</a></li>
    
    <li><a href="https://github.com/kenji-imi">GitHub</a></li>
    
    <li><a href="https://twitter.com/kimai007">Twitter</a></li>
    
    <li><a href="https://www.linkedin.com/in/kenji-imai-87a74741/">LinkedIn</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">5 min read</span>
    

    <h1 class="article-title">Docker上のElasticsearchをcurlで操作する</h1>

    
    <span class="article-date">September 18, 2019</span>
    

    <div class="article-content">
      <h2 id="概要">概要</h2>
<p>Docker 上の Elasticsearch を curl で API 操作してみます。</p>
<h2 id="環境">環境</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ sw_vers
ProductName:	Mac OS X
ProductVersion:	10.14.6
BuildVersion:	18G87
</code></pre></div><h2 id="elasticsearch-用-docker-compose">Elasticsearch 用 docker-compose</h2>
<p>今回は、docker コンテナを起動して、その中で Elasticsearch を起動します。
docker コンテナを起動するために、docker-compose を利用します。
Elasticsearch 用の Docker イメージや docker-compose.yml 等の情報は以下公式ドキュメントにまとまっています。</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html">Install Elasticsearch with Docker | Elasticsearch Reference | Elastic</a></li>
</ul>
<p>今回用いる docker-compose.yml は以下。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.3&#34;</span>
<span style="color:#f92672">services</span>:
  <span style="color:#f92672">es01</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">docker.elastic.co/elasticsearch/elasticsearch:7.3.0</span>
    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">es01</span>
    <span style="color:#f92672">environment</span>:
      - <span style="color:#e6db74">&#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&#34;</span>
      - <span style="color:#e6db74">&#34;discovery.type=single-node&#34;</span>
    <span style="color:#f92672">ulimits</span>:
      <span style="color:#f92672">memlock</span>:
        <span style="color:#f92672">soft</span>: -<span style="color:#ae81ff">1</span>
        <span style="color:#f92672">hard</span>: -<span style="color:#ae81ff">1</span>
    <span style="color:#f92672">volumes</span>:
      - <span style="color:#ae81ff">esdata01:/usr/share/elasticsearch/data</span>
    <span style="color:#f92672">ports</span>:
      - <span style="color:#ae81ff">9200</span>:<span style="color:#ae81ff">9200</span>
    <span style="color:#f92672">networks</span>:
      - <span style="color:#ae81ff">esnet</span>

<span style="color:#f92672">volumes</span>:
  <span style="color:#f92672">esdata01</span>:
    <span style="color:#f92672">driver</span>: <span style="color:#ae81ff">local</span>

<span style="color:#f92672">networks</span>: <span style="color:#f92672">esnet</span>:
</code></pre></div><p>Docker コンテナ起動</p>
<pre><code>$ docker-compose up
</code></pre><h2 id="curl-で起動確認">curl で起動確認</h2>
<p>Elasticsearch が起動されているかどうか curl で確認します。
デフォルトでは 9200 番ポートで API を利用。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ curl localhost:9200
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;753d7d8524f6&#34;</span>,
  <span style="color:#e6db74">&#34;cluster_name&#34;</span> : <span style="color:#e6db74">&#34;docker-cluster&#34;</span>,
  <span style="color:#e6db74">&#34;cluster_uuid&#34;</span> : <span style="color:#e6db74">&#34;YVCIA1RzROi-AQ80Csa5CQ&#34;</span>,
  <span style="color:#e6db74">&#34;version&#34;</span> : <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;number&#34;</span> : <span style="color:#e6db74">&#34;7.3.0&#34;</span>,
    <span style="color:#e6db74">&#34;build_flavor&#34;</span> : <span style="color:#e6db74">&#34;default&#34;</span>,
    <span style="color:#e6db74">&#34;build_type&#34;</span> : <span style="color:#e6db74">&#34;docker&#34;</span>,
    <span style="color:#e6db74">&#34;build_hash&#34;</span> : <span style="color:#e6db74">&#34;de777fa&#34;</span>,
    <span style="color:#e6db74">&#34;build_date&#34;</span> : <span style="color:#e6db74">&#34;2019-07-24T18:30:11.767338Z&#34;</span>,
    <span style="color:#e6db74">&#34;build_snapshot&#34;</span> : false,
    <span style="color:#e6db74">&#34;lucene_version&#34;</span> : <span style="color:#e6db74">&#34;8.1.0&#34;</span>,
    <span style="color:#e6db74">&#34;minimum_wire_compatibility_version&#34;</span> : <span style="color:#e6db74">&#34;6.8.0&#34;</span>,
    <span style="color:#e6db74">&#34;minimum_index_compatibility_version&#34;</span> : <span style="color:#e6db74">&#34;6.0.0-beta1&#34;</span>
  <span style="color:#f92672">}</span>,
  <span style="color:#e6db74">&#34;tagline&#34;</span> : <span style="color:#e6db74">&#34;You Know, for Search&#34;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>9200 ポート確認</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ lsof -i:9200
COMMAND    PID  USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME
com.docke <span style="color:#ae81ff">1502</span> user   17u  IPv6 0x3e5fb7c38bbe7217      0t0  TCP *:wap-wsp <span style="color:#f92672">(</span>LISTEN<span style="color:#f92672">)</span>
</code></pre></div><h2 id="インデックス作成">インデックス作成</h2>
<p>データ投入・検索を行う前にインデックスを作成します。
ここでは、インデックス名 <code>product</code> で作成。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ curl -XPUT localhost:9200/product
<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;acknowledged&#34;</span>:true,<span style="color:#e6db74">&#34;shards_acknowledged&#34;</span>:true,<span style="color:#e6db74">&#34;index&#34;</span>:<span style="color:#e6db74">&#34;product&#34;</span><span style="color:#f92672">}</span>
</code></pre></div><p>上記コマンドの実行結果は、ワンラインで表示されるために見づらくなってしまいます。
見やすくするために、次のように<code>?pretty</code>を付与することで整形することが出来ます。（ <code>| jq .</code> でも同様）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ curl -XPUT <span style="color:#e6db74">&#39;localhost:9200/product?pretty&#39;</span>
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;acknowledged&#34;</span> : true,
  <span style="color:#e6db74">&#34;shards_acknowledged&#34;</span> : true,
  <span style="color:#e6db74">&#34;index&#34;</span> : <span style="color:#e6db74">&#34;product&#34;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>すでに作成済みのインデックスを作成しようとするとエラーになります。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ curl -XPUT <span style="color:#e6db74">&#39;localhost:9200/product?pretty&#39;</span>
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;error&#34;</span> : <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;root_cause&#34;</span> : <span style="color:#f92672">[</span>
      <span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#34;type&#34;</span> : <span style="color:#e6db74">&#34;resource_already_exists_exception&#34;</span>,
        <span style="color:#e6db74">&#34;reason&#34;</span> : <span style="color:#e6db74">&#34;index [product/43BfhxU6SUqNUcQ8dkDKAA] already exists&#34;</span>,
        <span style="color:#e6db74">&#34;index_uuid&#34;</span> : <span style="color:#e6db74">&#34;43BfhxU6SUqNUcQ8dkDKAA&#34;</span>,
        <span style="color:#e6db74">&#34;index&#34;</span> : <span style="color:#e6db74">&#34;product&#34;</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">]</span>,
    <span style="color:#e6db74">&#34;type&#34;</span> : <span style="color:#e6db74">&#34;resource_already_exists_exception&#34;</span>,
    <span style="color:#e6db74">&#34;reason&#34;</span> : <span style="color:#e6db74">&#34;index [product/43BfhxU6SUqNUcQ8dkDKAA] already exists&#34;</span>,
    <span style="color:#e6db74">&#34;index_uuid&#34;</span> : <span style="color:#e6db74">&#34;43BfhxU6SUqNUcQ8dkDKAA&#34;</span>,
    <span style="color:#e6db74">&#34;index&#34;</span> : <span style="color:#e6db74">&#34;product&#34;</span>
  <span style="color:#f92672">}</span>,
  <span style="color:#e6db74">&#34;status&#34;</span> : <span style="color:#ae81ff">400</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>その場合は、一度インデックスを消して、再度作成を行います。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ curl -XDELETE <span style="color:#e6db74">&#39;localhost:9200/product?pretty&#39;</span>
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;acknowledged&#34;</span> : true
<span style="color:#f92672">}</span>
</code></pre></div><p>作成されたインデックスを確認します。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ curl <span style="color:#e6db74">&#39;localhost:9200/_cat/indices?v&#39;</span>
health status index   uuid                   pri rep docs.count docs.deleted store.size pri.store.size
yellow open   product Fz1qlOcwQyS-w0ZvKRmi4g   <span style="color:#ae81ff">1</span>   <span style="color:#ae81ff">1</span>          <span style="color:#ae81ff">0</span>            <span style="color:#ae81ff">0</span>       230b           230b
</code></pre></div><p>APIリファレンス</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html">Create index API</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-delete-index.html">Delete index API</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cat.html">cat APIs</a></li>
</ul>
<h2 id="データ投入">データ投入</h2>
<p>ここでは、ドキュメントが１つも入っていない状態で、新規にドキュメント登録を行います。
データ登録は <code>[インデックス名]/[タイプ]/[ドキュメントID]</code>  のように指定することで行うことが出来ます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ curl -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -XPUT <span style="color:#e6db74">&#39;localhost:9200/product/book/1?pretty&#39;</span> -d <span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">{
</span><span style="color:#e6db74">  &#34;date&#34;: &#34;2019-09-15T18:19:57+09:00&#34;,
</span><span style="color:#e6db74">  &#34;title&#34;: &#34;Elasticsearch&#34;,
</span><span style="color:#e6db74">  &#34;desc&#34;: &#34;これはElasticsearchに関する商品です&#34;
</span><span style="color:#e6db74">}&#39;</span>
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;_index&#34;</span> : <span style="color:#e6db74">&#34;product&#34;</span>,
  <span style="color:#e6db74">&#34;_type&#34;</span> : <span style="color:#e6db74">&#34;book&#34;</span>,
  <span style="color:#e6db74">&#34;_id&#34;</span> : <span style="color:#e6db74">&#34;1&#34;</span>,
  <span style="color:#e6db74">&#34;_version&#34;</span> : 2,
  <span style="color:#e6db74">&#34;result&#34;</span> : <span style="color:#e6db74">&#34;updated&#34;</span>,
  <span style="color:#e6db74">&#34;_shards&#34;</span> : <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;total&#34;</span> : 2,
    <span style="color:#e6db74">&#34;successful&#34;</span> : 1,
    <span style="color:#e6db74">&#34;failed&#34;</span> : <span style="color:#ae81ff">0</span>
  <span style="color:#f92672">}</span>,
  <span style="color:#e6db74">&#34;_seq_no&#34;</span> : 1,
  <span style="color:#e6db74">&#34;_primary_term&#34;</span> : <span style="color:#ae81ff">1</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>APIリファレンス</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-index_.html">Index API</a></li>
</ul>
<h2 id="検索">検索</h2>
<p>登録したドキュメントを検索してみます。
検索は <code>[インデックス名]/_search</code>  のように指定することで行うことが出来ます。
検索キーワード・検索対象フィールドは、クエリパラメータとして <code>q=</code> の後に <code>フィールド名:検索キーワード</code> で指定できます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ curl -XGET <span style="color:#e6db74">&#39;localhost:9200/product/_search?q=title:Elasticsearch&amp;pretty&#39;</span>
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;took&#34;</span> : 564,
  <span style="color:#e6db74">&#34;timed_out&#34;</span> : false,
  <span style="color:#e6db74">&#34;_shards&#34;</span> : <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;total&#34;</span> : 1,
    <span style="color:#e6db74">&#34;successful&#34;</span> : 1,
    <span style="color:#e6db74">&#34;skipped&#34;</span> : 0,
    <span style="color:#e6db74">&#34;failed&#34;</span> : <span style="color:#ae81ff">0</span>
  <span style="color:#f92672">}</span>,
  <span style="color:#e6db74">&#34;hits&#34;</span> : <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;total&#34;</span> : <span style="color:#f92672">{</span>
      <span style="color:#e6db74">&#34;value&#34;</span> : 1,
      <span style="color:#e6db74">&#34;relation&#34;</span> : <span style="color:#e6db74">&#34;eq&#34;</span>
    <span style="color:#f92672">}</span>,
    <span style="color:#e6db74">&#34;max_score&#34;</span> : 0.18232156,
    <span style="color:#e6db74">&#34;hits&#34;</span> : <span style="color:#f92672">[</span>
      <span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#34;_index&#34;</span> : <span style="color:#e6db74">&#34;product&#34;</span>,
        <span style="color:#e6db74">&#34;_type&#34;</span> : <span style="color:#e6db74">&#34;book&#34;</span>,
        <span style="color:#e6db74">&#34;_id&#34;</span> : <span style="color:#e6db74">&#34;1&#34;</span>,
        <span style="color:#e6db74">&#34;_score&#34;</span> : 0.18232156,
        <span style="color:#e6db74">&#34;_source&#34;</span> : <span style="color:#f92672">{</span>
          <span style="color:#e6db74">&#34;date&#34;</span> : <span style="color:#e6db74">&#34;2019-09-15T18:19:57+09:00&#34;</span>,
          <span style="color:#e6db74">&#34;title&#34;</span> : <span style="color:#e6db74">&#34;Elasticsearch&#34;</span>,
          <span style="color:#e6db74">&#34;desc&#34;</span> : <span style="color:#e6db74">&#34;これはElasticsearchに関する商品です&#34;</span>
        <span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">]</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>また、 <code>[インデックス名]/[タイプ]/_search</code>  と指定することで 特定のタイプのドキュメントを検索することが出来ます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ curl -XGET <span style="color:#e6db74">&#39;localhost:9200/product/book/_search?q=title:Elasticsearch&amp;pretty&#39;</span>
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;took&#34;</span> : 9,
  <span style="color:#e6db74">&#34;timed_out&#34;</span> : false,
  <span style="color:#e6db74">&#34;_shards&#34;</span> : <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;total&#34;</span> : 1,
    <span style="color:#e6db74">&#34;successful&#34;</span> : 1,
    <span style="color:#e6db74">&#34;skipped&#34;</span> : 0,
    <span style="color:#e6db74">&#34;failed&#34;</span> : <span style="color:#ae81ff">0</span>
  <span style="color:#f92672">}</span>,
  <span style="color:#e6db74">&#34;hits&#34;</span> : <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;total&#34;</span> : <span style="color:#f92672">{</span>
      <span style="color:#e6db74">&#34;value&#34;</span> : 1,
      <span style="color:#e6db74">&#34;relation&#34;</span> : <span style="color:#e6db74">&#34;eq&#34;</span>
    <span style="color:#f92672">}</span>,
    <span style="color:#e6db74">&#34;max_score&#34;</span> : 0.18232156,
    <span style="color:#e6db74">&#34;hits&#34;</span> : <span style="color:#f92672">[</span>
      <span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#34;_index&#34;</span> : <span style="color:#e6db74">&#34;product&#34;</span>,
        <span style="color:#e6db74">&#34;_type&#34;</span> : <span style="color:#e6db74">&#34;book&#34;</span>,
        <span style="color:#e6db74">&#34;_id&#34;</span> : <span style="color:#e6db74">&#34;1&#34;</span>,
        <span style="color:#e6db74">&#34;_score&#34;</span> : 0.18232156,
        <span style="color:#e6db74">&#34;_source&#34;</span> : <span style="color:#f92672">{</span>
          <span style="color:#e6db74">&#34;date&#34;</span> : <span style="color:#e6db74">&#34;2019-09-15T18:19:57+09:00&#34;</span>,
          <span style="color:#e6db74">&#34;title&#34;</span> : <span style="color:#e6db74">&#34;Elasticsearch&#34;</span>,
          <span style="color:#e6db74">&#34;desc&#34;</span> : <span style="color:#e6db74">&#34;これはElasticsearchに関する商品です&#34;</span>
        <span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">]</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>APIリファレンス</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-search.html">Search</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-uri-request.html">URI Search</a></li>
<li>細かく検索条件をしていたい場合は以下を使用する
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-body.html">Request Body Search</a></li>
</ul>
</li>
</ul>
<h2 id="ドキュメント更新">ドキュメント更新</h2>
<p>今度はドキュメントIDが1のtitleフィールドを更新します。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ curl -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -XPOST <span style="color:#e6db74">&#39;localhost:9200/product/book/1/_update?pretty&#39;</span> -d <span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">{
</span><span style="color:#e6db74">  &#34;doc&#34; : {
</span><span style="color:#e6db74">      &#34;title&#34; : &#34;Elasticsearch v7.3&#34;
</span><span style="color:#e6db74">  }
</span><span style="color:#e6db74">}&#39;</span>
</code></pre></div><p>更新後もう一度検索してみると、titleフィールドの取得値が更新されていることが確認できます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ curl -XGET <span style="color:#e6db74">&#39;localhost:9200/product/_search?q=title:Elasticsearch&amp;pretty&#39;</span>
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;took&#34;</span> : 7,
  <span style="color:#e6db74">&#34;timed_out&#34;</span> : false,
  <span style="color:#e6db74">&#34;_shards&#34;</span> : <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;total&#34;</span> : 1,
    <span style="color:#e6db74">&#34;successful&#34;</span> : 1,
    <span style="color:#e6db74">&#34;skipped&#34;</span> : 0,
    <span style="color:#e6db74">&#34;failed&#34;</span> : <span style="color:#ae81ff">0</span>
  <span style="color:#f92672">}</span>,
  <span style="color:#e6db74">&#34;hits&#34;</span> : <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;total&#34;</span> : <span style="color:#f92672">{</span>
      <span style="color:#e6db74">&#34;value&#34;</span> : 1,
      <span style="color:#e6db74">&#34;relation&#34;</span> : <span style="color:#e6db74">&#34;eq&#34;</span>
    <span style="color:#f92672">}</span>,
    <span style="color:#e6db74">&#34;max_score&#34;</span> : 0.2876821,
    <span style="color:#e6db74">&#34;hits&#34;</span> : <span style="color:#f92672">[</span>
      <span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#34;_index&#34;</span> : <span style="color:#e6db74">&#34;product&#34;</span>,
        <span style="color:#e6db74">&#34;_type&#34;</span> : <span style="color:#e6db74">&#34;book&#34;</span>,
        <span style="color:#e6db74">&#34;_id&#34;</span> : <span style="color:#e6db74">&#34;1&#34;</span>,
        <span style="color:#e6db74">&#34;_score&#34;</span> : 0.2876821,
        <span style="color:#e6db74">&#34;_source&#34;</span> : <span style="color:#f92672">{</span>
          <span style="color:#e6db74">&#34;date&#34;</span> : <span style="color:#e6db74">&#34;2019-09-15T18:19:57+09:00&#34;</span>,
          <span style="color:#e6db74">&#34;title&#34;</span> : <span style="color:#e6db74">&#34;Elasticsearch v7.3&#34;</span>,
          <span style="color:#e6db74">&#34;desc&#34;</span> : <span style="color:#e6db74">&#34;これはElasticsearchに関する商品です&#34;</span>
        <span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">]</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>APIリファレンス</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-update.html">Update API</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-update-by-query.html">Update By Query API</a></li>
</ul>
<h2 id="ドキュメント削除">ドキュメント削除</h2>
<p>最後に、更新したドキュメントを削除してみます。</p>
<pre><code>$ curl -XDELETE 'localhost:9200/product/book/1?pretty'
{
  &quot;_index&quot; : &quot;product&quot;,
  &quot;_type&quot; : &quot;book&quot;,
  &quot;_id&quot; : &quot;1&quot;,
  &quot;_version&quot; : 4,
  &quot;result&quot; : &quot;deleted&quot;,
  &quot;_shards&quot; : {
    &quot;total&quot; : 2,
    &quot;successful&quot; : 1,
    &quot;failed&quot; : 0
  },
  &quot;_seq_no&quot; : 3,
  &quot;_primary_term&quot; : 2
}
</code></pre><p>削除後にもう一度検索してみると、先程までヒットしていたドキュメントがヒットしなくなり、ドキュメントが正しく削除されていることが確認できます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ curl -XGET <span style="color:#e6db74">&#39;localhost:9200/product/_search?q=title:Elasticsearch&amp;pretty&#39;</span>
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;took&#34;</span> : 713,
  <span style="color:#e6db74">&#34;timed_out&#34;</span> : false,
  <span style="color:#e6db74">&#34;_shards&#34;</span> : <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;total&#34;</span> : 1,
    <span style="color:#e6db74">&#34;successful&#34;</span> : 1,
    <span style="color:#e6db74">&#34;skipped&#34;</span> : 0,
    <span style="color:#e6db74">&#34;failed&#34;</span> : <span style="color:#ae81ff">0</span>
  <span style="color:#f92672">}</span>,
  <span style="color:#e6db74">&#34;hits&#34;</span> : <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;total&#34;</span> : <span style="color:#f92672">{</span>
      <span style="color:#e6db74">&#34;value&#34;</span> : 0,
      <span style="color:#e6db74">&#34;relation&#34;</span> : <span style="color:#e6db74">&#34;eq&#34;</span>
    <span style="color:#f92672">}</span>,
    <span style="color:#e6db74">&#34;max_score&#34;</span> : null,
    <span style="color:#e6db74">&#34;hits&#34;</span> : <span style="color:#f92672">[</span> <span style="color:#f92672">]</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>APIリファレンス</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-delete.html">Delete API</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-delete-by-query.html">Delete by query API</a></li>
</ul>
<h2 id="エラーメモ">エラーメモ</h2>
<p>APIリクエストを試す中でエラーとなったケースを列挙していく</p>
<h4 id="ドキュメント更新リクエスト">ドキュメント更新リクエスト</h4>
<p>フィールド指定が正しくない場合</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ curl -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -XPOST <span style="color:#e6db74">&#39;localhost:9200/product/book/1/_update?pretty&#39;</span> -d <span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">{
</span><span style="color:#e6db74">  &#34;doc&#34; : {
</span><span style="color:#e6db74">      &#34;title&#34; : &#34;Elasticsearch v7.3&#34;
</span><span style="color:#e6db74">  }
</span><span style="color:#e6db74">}&#39;</span>
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;error&#34;</span> : <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;root_cause&#34;</span> : <span style="color:#f92672">[</span>
      <span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#34;type&#34;</span> : <span style="color:#e6db74">&#34;x_content_parse_exception&#34;</span>,
        <span style="color:#e6db74">&#34;reason&#34;</span> : <span style="color:#e6db74">&#34;[1:2] [UpdateRequest] unknown field [title], parser not found&#34;</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">]</span>,
    <span style="color:#e6db74">&#34;type&#34;</span> : <span style="color:#e6db74">&#34;x_content_parse_exception&#34;</span>,
    <span style="color:#e6db74">&#34;reason&#34;</span> : <span style="color:#e6db74">&#34;[1:2] [UpdateRequest] unknown field [title], parser not found&#34;</span>
  <span style="color:#f92672">}</span>,
  <span style="color:#e6db74">&#34;status&#34;</span> : <span style="color:#ae81ff">400</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>titleフィールドの指定で、 title文字列を <code>&quot;</code> で囲まなかった場合</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ curl -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -XPOST <span style="color:#e6db74">&#39;localhost:9200/product/book/1/_update?pretty&#39;</span> -d <span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">{
</span><span style="color:#e6db74">  &#34;doc&#34; : {
</span><span style="color:#e6db74">      &#34;title&#34; : &#34;Elasticsearch v7.3&#34;
</span><span style="color:#e6db74">  }
</span><span style="color:#e6db74">}&#39;</span>
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;error&#34;</span> : <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;root_cause&#34;</span> : <span style="color:#f92672">[</span>
      <span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#34;type&#34;</span> : <span style="color:#e6db74">&#34;json_parse_exception&#34;</span>,
        <span style="color:#e6db74">&#34;reason&#34;</span> : <span style="color:#e6db74">&#34;Unexpected character (&#39;t&#39; (code 116)): was expecting double-quote to start field name\n at [Source: org.elasticsearch.transport.netty4.ByteBufStreamInput@3abb9f17; line: 1, column: 3]&#34;</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">]</span>,
    <span style="color:#e6db74">&#34;type&#34;</span> : <span style="color:#e6db74">&#34;json_parse_exception&#34;</span>,
    <span style="color:#e6db74">&#34;reason&#34;</span> : <span style="color:#e6db74">&#34;Unexpected character (&#39;t&#39; (code 116)): was expecting double-quote to start field name\n at [Source: org.elasticsearch.transport.netty4.ByteBufStreamInput@3abb9f17; line: 1, column: 3]&#34;</span>
  <span style="color:#f92672">}</span>,
  <span style="color:#e6db74">&#34;status&#34;</span> : <span style="color:#ae81ff">500</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>POSTではなくPUTでリクエストしてしまった場合</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ curl -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -XPUT <span style="color:#e6db74">&#39;localhost:9200/product/book/1/_update?pretty&#39;</span> -d <span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">{
</span><span style="color:#e6db74">  &#34;doc&#34; : {
</span><span style="color:#e6db74">      &#34;title&#34; : &#34;Elasticsearch v7.3&#34;
</span><span style="color:#e6db74">  }
</span><span style="color:#e6db74">}&#39;</span>
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;error&#34;</span> : <span style="color:#e6db74">&#34;Incorrect HTTP method for uri [/product/book/1/_update?pretty] and method [PUT], allowed: [POST]&#34;</span>,
  <span style="color:#e6db74">&#34;status&#34;</span> : <span style="color:#ae81ff">405</span>
<span style="color:#f92672">}</span>
</code></pre></div>
    </div>
  </article>

  

</main>

      <footer class="footer">
        <ul class="footer-links">
          
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with <img src="https://kenji-imi.github.io/images/hugo-logo.png" width="22" height="22"></a>
          </li>
        </ul>
      </footer>

    </div>

    
  </body>
</html>

